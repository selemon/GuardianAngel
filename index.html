<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <!--<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />-->
    <!--<link rel="stylesheet" href="style.css"/>-->
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v2.js"></script>
</head>
<body>

<div id="frontPage">
    <h1>Crime Rate Finder</h1>
    <p>
        Find out the crime rate where you are.
    </p>
    <p>
        <button id="button" onclick="GetMap()">Show Crime Rate</button>
    </p>

</div>
<div id="mapDiv" style="position: absolute; width: 100%; height: 100%;"></div>
<script type="text/javascript">
    var map = null;
    var userLocation = null;
    var userLatLng = null;
    var carLatLng = null;
    var geocoder = null;
    function GetMap() {
        /* Replace YOUR_BING_MAPS_KEY with your own credentials.
         Obtain a key by signing up for a developer account at
         http://www.microsoft.com/maps/developers/ */
        var cred = "YOUR_BING_MAPS_KEY";
        var userLatLng = null;
//        var carLatLng = null;

        // Check if browser supports geolocation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(locateSuccess, locateFail);
        }
        else {
            alert("'I'm sorry, but Geolocation is not supported in your current browser.'");
        }

//        if (userLocation != null) {
//            userLatLng = new google.maps.LatLng(userLocation.coords.latitude, userLocation.coords.longitude);
//        }
    }
    function toDo(){
        var options = {
            zoom: 10,
            disableDefaultUI: false,
            streetViewControl: true,
            center: new google.maps.LatLng(-34.397, 150.644),
            mapTypeId: google.maps.MapTypeId.SATELLITE
        }
        // Initialize map
        map = new google.maps.Map(document.getElementById("mapDiv"), options);
        var marker = new google.maps.Marker({
            position: userLatLng,
            map: map,
            title: 'Your position'
        });
        geocoder = new google.maps.Geocoder();

        var circle = new google.maps.Circle({
            center: userLocation,
            radius: carLatLng.accuracy,
            map: map,
            fillColor: '#70E7FF',
            fillOpacity: 0.2,
            strokeColor: '#0000FF',
            strokeOpacity: 1.0,
            clickable: true
        });
//        map.fitBounds(circle.getBounds());

        map.setCenter(userLocation);
        map.setZoom(17);

        //add an event listener to circle
        google.maps.event.addListener(circle, 'click', function()
        {
            alert('89 crimes committed in this area');
            //displayInfo(circle);
        });
//        getData();
        read();
    }

    // Successful geolocation
    function locateSuccess(loc) {

        carLatLng = {
            latitude: loc.coords.latitude,
            longitude: loc.coords.longitude,
            accuracy: loc.coords.accuracy
        };

        // Set the user's location
        userLocation = new google.maps.LatLng(loc.coords.latitude, loc.coords.longitude);
        toDo();

        //reverse geocoder to get the physical name of the locations
        geocoder.geocode({'latLng': userLocation}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                //we'll do cool crap here
                //Check result 0
                var result = results[0];
                //look for locality tag and administrative_area_level_1
                var city = "";
                var state = "";
                var street = "";
                for(var i=0, len=result.address_components.length; i<len; i++) {
                    var ac = result.address_components[i];
                    if(ac.types.indexOf("postal_code") >= 0) city = ac.long_name;
                    if(ac.types.indexOf("administrative_area_level_1") >= 0) state = ac.long_name;
                    if(ac.types.indexOf("street_number") >= 0) street = ac.long_name;
                    if(ac.types.indexOf("route") >= 0) street +=" "+ ac.long_name;
                    if(ac.types.indexOf("locality") >= 0) street +=" "+ ac.long_name;
                }
                //only report if we got Good Stuff
                if(city != '' && state != '') {
                    alert("Hello to you out there in "+city+", "+state+"!"+", "+street);
                }
            }
        });
    }
    // Unsuccessful geolocation
    function locateFail(geoPositionError) {
        alert("error son");
    }


    /**
     *
     *
     // Display route to the car
     options = {
suppressMarkers: true,
map: map,
preserveViewport: true
}
     this.setRoute(new google.maps.DirectionsRenderer(options), userLatLng, carLatLng);
     }

     $.mobile.loading('hide');
     }


     // Calculate the route from the user to his car

    Map.setRoute = function(directionsDisplay, userLatLng, carLatLng)
    {
        var directionsService = new google.maps.DirectionsService();
        var request = {
            origin: userLatLng,
            destination: carLatLng,
            travelMode: google.maps.DirectionsTravelMode.WALKING,
            unitSystem: google.maps.UnitSystem.METRIC
        };

        directionsService.route(
                request,
                function(response, status)
                {
                    if (status == google.maps.DirectionsStatus.OK)
                        directionsDisplay.setDirections(response);
                    else
                    {
                        navigator.notification.alert(
                                'Unable to retrieve a route to your car. However, you can still find it by your own.',
                                function(){},
                                'Warning'
                        );
                    }
                }
        );
    }


    //  Request the address of the retrieved location

    Map.requestLocation = function(position)
    {
        new google.maps.Geocoder().geocode(
                {
                    'location': new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
                },
                function(results, status)
                {
                    if (status == google.maps.GeocoderStatus.OK)
                    {
                        var positions = new Position();
                        positions.updatePosition(0, positions.getPositions()[0].coords, results[0].formatted_address);
                    }
                }
        );
    }
    **/


    //ajax to communicate with the server
    //method for retreving data about crime
    function getData(){
        //call server with ajax call.
        $.ajax({
            dataType: 'json',
            method: 'GET',
            url: "http://crime-rate.herokuapp.com/getData"
        }).done(function(data){
        //to do when successful
            alert(data.hello);
        }).fail(function(jgXHR, textStatus, errorThrown){
            alert('Server Connection Error');			//let user know something is wrong.
            console.log('ERROR: '+textStatus+ errorThrown);
        });
    }

    function postData(){
        //call server with ajax call.
        $.ajax({
            dataType: 'json',
            method: 'POST',
            data: {
                data: o
            },
            url: "http://crime-rate.herokuapp.com/PostData"
        }).done(function(data){
            //to do when successful
            alert(data.hello);
        }).fail(function(jgXHR, textStatus, errorThrown){
            alert('Server Connection Error');			//let user know something is wrong.
            console.log('ERROR: '+textStatus+ errorThrown);
        });
    }

    $("#button").on("click", function () {
        $("#mapDiv").show();
        $("#frontPage").hide();
    });

    $(document).on("mobileinit", function(){
        $("#mapDiv").hide();
//        $("#mapDiv").show();

    });

    var qu;
    var o = "";
    function read(){
        function parse(){
            d3.csv("CrimeDataNzCurrent.csv", function(error, data) {
                qu = data;
                o = 'INSERT INTO data (Event_ID, Code, Event_Type, Category, Status, Location, Suburb, City, Published)';
                qu.forEach(function(d){
                    o+= ' VALUES ($$'+ d.Event_ID+'$$, $$'+ d.Code+'$$, $$'+ d.Event_Type+'$$, $$'+ d.Category+'$$, $$'+ d.Status+'$$, $$'+ d.Location+'$$, $$'+ d.Suburb+'$$, $$'+ d.City+'$$, $$'+ d.Published+'$$);';
                    o+= ' INSERT INTO data (Event_ID, Code, Event_Type, Category, Status, Location, Suburb, City, Published)';

                });
                postData();
            });
        }
    }


</script>
</body>
</html>
